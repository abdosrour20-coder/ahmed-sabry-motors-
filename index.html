<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>AHMED SABRY MOTORS</title>
<style>
body{font-family:Arial;background:#f4f6f8;padding:20px}
.box{background:#fff;max-width:1200px;margin:auto;padding:20px;border-radius:12px;box-shadow:0 0 10px #ccc}
h2{text-align:center}
label{display:block;margin-top:8px}
input,select{width:100%;padding:7px;margin-top:4px}
button{padding:8px 14px;margin-top:10px;border:none;border-radius:5px;background:#0d6efd;color:#fff;cursor:pointer;}
.whatsapp{background:#25d366;margin-top:4px;}
table{width:100%;border-collapse:collapse;margin-top:15px;font-size:14px}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
.totalBox{margin-top:10px;background:#eee;padding:10px;font-weight:bold;}
.summaryBox{margin-top:15px;background:#dff0d8;padding:10px;border-radius:8px;}
</style>
</head>

<body>

<div class="box">
<h2>AHMED SABRY MOTORS – سجل الرحلات</h2>

<label>رقم واتساب لإرسال الفواتير</label>
<input id="whatsappNumber" type="text" placeholder="مثال: 201012345678">

<label>اسم السائق</label>
<input id="driver">

<label>السيارة</label>
<input id="car">

<label>المحافظات / خط السير</label>
<input id="route">

<label>هل الرحلة داخلية؟</label>
<select id="internal">
    <option value="نعم">نعم</option>
    <option value="لا">لا</option>
</select>

<label>ذهاب</label>
<input id="go" type="number">

<label>عودة</label>
<input id="return" type="number">

<label>البنزين</label>
<input id="fuel" type="number">

<label>المصاريف</label>
<input id="expenses" type="number">

<label>مرتب السائق</label>
<input id="driverSalary" type="number">

<label>متبقي للسائق (للفاتورة فقط)</label>
<input id="driverRemain" type="number">

<label>مرتب عبدالرحمن</label>
<input id="abdSalary" type="number">

<button onclick="addTrip()">إضافة رحلة</button>
<button onclick="exportExcel()">تصدير Excel</button>

<div class="totalBox">
إجمالي المتبقي: <span id="sumFinal">0</span> جنيه
</div>

<hr>

<h3>ملخص رحلات السائق</h3>
<label>اختر السائق:</label>
<select id="summaryDriver" onchange="showSummary()">
    <option value="">-- اختر السائق --</option>
</select>

<div class="summaryBox" id="summaryBox" style="display:none;">
<p id="summaryText"></p>
<button onclick="sendSummary()">إرسال الملخص على واتساب</button>
</div>

<table>
<thead>
<tr>
<th>التاريخ</th>
<th>السائق</th>
<th>السيارة</th>
<th>الخط</th>
<th>داخلية</th>
<th>ذهاب</th>
<th>عودة</th>
<th>المتبقي النهائي</th>
<th>فاتورة</th>
<th>حذف</th>
</tr>
</thead>
<tbody id="table"></tbody>
</table>
</div>

<!-- مكتبة SheetJS لتصدير Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
let trips = JSON.parse(localStorage.getItem("trips") || "[]");

function n(id){ return Number(document.getElementById(id).value || 0); }

function addTrip(){
    let trip = {
        date: new Date().toLocaleString("ar-EG"),
        driver: driver.value||"-",
        car: car.value||"-",
        route: route.value||"-",
        internal: internal.value,
        go: n("go"),
        return: n("return"),
        fuel: n("fuel"),
        expenses: n("expenses"),
        driverSalary: n("driverSalary"),
        driverRemain: n("driverRemain"), // للفاتورة فقط
        abdSalary: n("abdSalary")
    };

    // الحساب النهائي لا يشمل متبقي السائق
    trip.final = (trip.go + trip.return) - trip.fuel - trip.expenses - trip.driverSalary - trip.abdSalary;

    trips.push(trip);
    save();
    render();
    updateSummaryOptions();
}

function save(){
    localStorage.setItem("trips",JSON.stringify(trips));
}

function render(){
    table.innerHTML = "";
    let sum = 0;
    trips.forEach((t,i)=>{
        sum += t.final;
        table.innerHTML += `
        <tr>
            <td>${t.date}</td>
            <td>${t.driver}</td>
            <td>${t.car}</td>
            <td>${t.route}</td>
            <td>${t.internal}</td>
            <td>${t.go}</td>
            <td>${t.return}</td>
            <td>${t.final}</td>
            <td><button class="whatsapp" onclick="send(${i})">واتساب</button></td>
            <td><button onclick="del(${i})">حذف</button></td>
        </tr>`;
    });
    sumFinal.innerText = sum;
}

function del(i){
    if(confirm("حذف الرحلة؟")){
        trips.splice(i,1);
        save();
        render();
        updateSummaryOptions();
    }
}

function send(i){
    let t = trips[i];
    let phone = document.getElementById("whatsappNumber").value;
    if(!phone){
        alert("ادخل رقم الواتساب في أعلى الصفحة");
        return;
    }

    let msg = 
`AHMED SABRY MOTORS
${t.date}

السائق: ${t.driver}
السيارة: ${t.car}
الخط: ${t.route}
رحلة داخلية: ${t.internal}

ذهاب: ${t.go}
عودة: ${t.return}
البنزين: ${t.fuel}
المصاريف: ${t.expenses}

مرتب السائق: ${t.driverSalary}
متبقي للسائق: ${t.driverRemain}
مرتب عبدالرحمن: ${t.abdSalary}

المتبقي النهائي: ${t.final}`;

    window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`,"_blank");
}

// -------------------- ملخص السائق --------------------
function updateSummaryOptions(){
    let select = document.getElementById("summaryDriver");
    let drivers = [...new Set(trips.map(t => t.driver))];
    select.innerHTML = '<option value="">-- اختر السائق --</option>';
    drivers.forEach(d => {
        select.innerHTML += `<option value="${d}">${d}</option>`;
    });
}

function showSummary(){
    let driver = document.getElementById("summaryDriver").value;
    if(!driver){
        document.getElementById("summaryBox").style.display="none";
        return;
    }

    let driverTrips = trips.filter(t => t.driver === driver);
    let totalGo = driverTrips.reduce((a,b)=>a+b.go,0);
    let totalReturn = driverTrips.reduce((a,b)=>a+b.return,0);
    let totalFuel = driverTrips.reduce((a,b)=>a+b.fuel,0);
    let totalExpenses = driverTrips.reduce((a,b)=>a+b.expenses,0);
    let totalDriverSalary = driverTrips.reduce((a,b)=>a+b.driverSalary,0);
    let totalAbdSalary = driverTrips.reduce((a,b)=>a+b.abdSalary,0);

    let final = (totalGo + totalReturn) - totalFuel - totalExpenses - totalDriverSalary - totalAbdSalary;

    document.getElementById("summaryText").innerText = 
`ملخص رحلات السائق: ${driver}

عدد الرحلات: ${driverTrips.length}
إجمالي ذهاب: ${totalGo}
إجمالي عودة: ${totalReturn}
إجمالي البنزين: ${totalFuel}
إجمالي المصاريف: ${totalExpenses}
إجمالي مرتب السائق: ${totalDriverSalary}
إجمالي مرتب عبدالرحمن: ${totalAbdSalary}
المتبقي النهائي لجميع الرحلات: ${final}`;

    document.getElementById("summaryBox").style.display = "block";
}

function sendSummary(){
    let driver = document.getElementById("summaryDriver").value;
    if(!driver) return;
    let phone = document.getElementById("whatsappNumber").value;
    if(!phone){
        alert("ادخل رقم الواتساب في أعلى الصفحة");
        return;
    }
    let driverTrips = trips.filter(t => t.driver === driver);
    let totalGo = driverTrips.reduce((a,b)=>a+b.go,0);
    let totalReturn = driverTrips.reduce((a,b)=>a+b.return,0);
    let totalFuel = driverTrips.reduce((a,b)=>a+b.fuel,0);
    let totalExpenses = driverTrips.reduce((a,b)=>a+b.expenses,0);
    let totalDriverSalary = driverTrips.reduce((a,b)=>a+b.driverSalary,0);
    let totalAbdSalary = driverTrips.reduce((a,b)=>a+b.abdSalary,0);

    let final = (totalGo + totalReturn) - totalFuel - totalExpenses - totalDriverSalary - totalAbdSalary;

    let msg = 
`AHMED SABRY MOTORS
ملخص رحلات السائق: ${driver}

عدد الرحلات: ${driverTrips.length}
إجمالي ذهاب: ${totalGo}
إجمالي عودة: ${totalReturn}
إجمالي البنزين: ${totalFuel}
إجمالي المصاريف: ${totalExpenses}
إجمالي مرتب السائق: ${totalDriverSalary}
إجمالي مرتب عبدالرحمن: ${totalAbdSalary}
المتبقي النهائي لجميع الرحلات: ${final}`;

    window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`,"_blank");
}

// -------------------- تصدير Excel --------------------
function exportExcel(){
    if(trips.length === 0){
        alert("لا توجد رحلات لتصديرها!");
        return;
    }

    // إعداد بيانات Excel
    const ws_data = [
        ["التاريخ","السائق","السيارة","الخط","داخلية","ذهاب","عودة","البنزين","المصاريف","مرتب السائق","متبقي للسائق","مرتب عبدالرحمن","المتبقي النهائي"]
    ];

    trips.forEach(t=>{
        ws_data.push([
            t.date,t.driver,t.car,t.route,t.internal,
            t.go,t.return,t.fuel,t.expenses,t.driverSalary,t.driverRemain,t.abdSalary,t.final
        ]);
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "رحلات");
    XLSX.writeFile(wb, "AHMED_SABRY_MOTORS.xlsx");
}

// تحديث خيارات السائق عند تحميل الصفحة
updateSummaryOptions();
render();
</script>

</body>
</html>